# ArgoCD Installation Guide

## Table of Contents
- [ArgoCD Installation Guide](#Guide to install and setup ArgoCD)
  - [Table of Contents](#table-of-contents)
    - [Setup ArgoCD](#Setup ArgoCD)
    -[Accessing the Argo CD API Server](#Accessing the Argo CD API Server)
    - [Install ArgoCD CLI tool](#install-argocd-cli-tool)
      - [Linux](#linux)
      - [Mac](#mac)
      - [Windows](#windows)
    - [Login using CLI or GUI](#Login using CLI or GUI)
    - [Register a Cluster to Deploy apps to](#Register a Cluster to Deploy apps to)
    - [Install ArgoCD onto the cluster](#install-argocd-onto-the-cluster)


## Guide to install and setup ArgoCD

ArgoCD can be used through your CLI or a GUI - it is currently set up to manually sync new changes from the "main" branches of all the repos that contain the charts for each service.

The future aim would be to have a "staging" environment and a "production" environment. Changes would be automatically deployed to "staging" as this would be a mirror copy of "production" - then if all was well with the upgrade on "staging" then we merge the changes to "main" branch, which is turn upgrades that cluster automatically too.

ArgoCD is very easy to install and set up - if you want to get it working on your current machine, follow the details below.

### Setup ArgoCD

Installation of ArgoCD only needs to be done on a fresh cluster - this does not apply to any current clusters running ArgoCD already.

Requirements

Installed kubectl cli tool
- Have kubeconfig files set up (default location is ~/.kube/config)
- The config is easily populated using a command like below:

`az aks get-credentials --name <cluster name> --resource-group <cluster resource group>`

- Next to install the required services you would use the following commands:

```
kubectl create namespace argocd

kubectl apply -n argocd -f https://raw.githubusercontent.com/argoproj/argo-cd/stable/manifests/install.yaml

```
### Accessing the Argo CD API Server

In order to access the Argo CD API Server you use the following command to expose the external IP address. For future iterations of ArgoCD we can look to utilise SSO and SSL as extra layers of security. For now we are using basic http and manually adjusting passwords.

So to access you would need to use following command to change the argo-server service type to "LoadBalancer":

```bash
kubectl patch svc argocd-server -n argocd -p '{"spec": {"type": "LoadBalancer"}}'
```

Now run the following to get the public IP:

```bash
kubectl get svc -n argocd argocd-server

NAME            TYPE           CLUSTER-IP   EXTERNAL-IP    PORT(S)                      AGE
argocd-server   LoadBalancer   x.x.x.xxx   xxx.xx.xxx.xx   80:32117/TCP,443:30284/TCP   4d1h
```

Then if you go to the public IP you will be met by the login screen for ArgoCD


### Install ArgoCD CLI tool

You can interact with ArgoCD through the CLI or the gui. To install the cli tool, follow the below instructions:

#### Linux

Set up an environment variable to assign the most recent version number

```bash
VERSION=$(curl --silent "https://api.github.com/repos/argoproj/argo-cd/releases/latest" | grep '"tag_name"' | sed -E 's/.*"([^"]+)".*/\1/')
```

Next use curl to download the most recent Linux version:

```bash
curl -sSL -o /usr/local/bin/argocd https://github.com/argoproj/argo-cd/releases/download/$VERSION/argocd-linux-amd64
```

Lastly make the argocd CLI executable:

```bash
chmod +x /usr/local/bin/argocd
```
#### Mac

Use homebrew to install:

```bash
brew install argocd
```

#### Windows

If you are using Chocolatey, then install using command below:

```powershell
choco install argocd
```

Otherwise use the manual install below:

Download With Powershell: Invoke-WebRequestÂ¶
You can view the latest version of Argo CD at the link above or run the following command to grab the version:

```powershell
$version = (Invoke-RestMethod https://api.github.com/repos/argoproj/argo-cd/releases/latest).tag_name
Replace $version in the command below with the version of Argo CD you would like to download:
```

```powershell
$url = "https://github.com/argoproj/argo-cd/releases/download/" + $version + "/argocd-windows-amd64.exe"
$output = "argocd.exe"

Invoke-WebRequest -Uri $url -OutFile $output
```
Also please note you will probably need to move the file into your PATH.

After finishing the instructions above, you should now be able to run argocd commands


### Login using CLI or GUI

#### CLI Login

The password that is autogenerated to be the pod name of the Argo CD API Server. You can find this out with the following command:

```bash
kubectl get pods -n argocd -l app.kubernetes.io/name=argocd-server -o name | cut -d'/' -f 2
```

Using the username "admin" and the password above, login using the public IP of ArgoCD

```bash
argocd login <public IP>
```

Once logged in you will need to change the password

```bash
argocd account update-password
```

Once you're logged in you have full access to all the Argocd CLI commands and can deploy new charts or sync existing charts.

#### GUI Login

Pretty simple - go to the public IP and use the username "admin" and the password from the below command:

```bash
kubectl get pods -n argocd -l app.kubernetes.io/name=argocd-server -o name | cut -d'/' -f 2
```

### Register a Cluster to Deploy apps to

This is required if you want to deploy to external clusters using ArgoCD. Follow the below to add clusters:

```bash
argocd cluster add
```

Choose a context name from the list and supply it to the following command:

```bash
argocd cluster add <context name>
```


### Install ArgoCD onto the cluster

You will use Helm to install ArgoCD, follow the commands below to get it installed.

Firstly make sure you're using the correct context, this will be the context of the cluster you want to deploy to:

```bash

kubectl config get-contexts

kubectl config use-context <name of cluster>
```

Next you want to install the chart using helm

```bash
helm install ./charts/icap-infrastructure/argocd --generate-name
```