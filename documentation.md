# Instructions

## 1. Pre requisites
1. terraform 14.4
2. kubectx
3. kubectl
4. argocd
5. Microsoft account
6. Azure login and subsctiption, Service principal. 
7. Argocd Setup

## 1.1 Installtion of pre-requisites
### Mac Os

terraform 
 ```
brew install terraform
terraform -version
```
kubectx

```
brew install kubectx
```
kubectl
```
brew install kubectl
```

argocd

```
brew install argocd
```

## 1.2 Guide to install and setup ArgoCD

ArgoCD can be used through your CLI or a GUI - it is currently set up to manually sync new changes from the "main" branches of all the repos that contain the charts for each service.

The future aim would be to have a "staging" environment and a "production" environment. Changes would be automatically deployed to "staging" as this would be a mirror copy of "production" - then if all was well with the upgrade on "staging" then we merge the changes to "main" branch, which is turn upgrades that cluster automatically too.

ArgoCD is very easy to install and set up - if you want to get it working on your current machine, follow the details below.

### Install ArgoCD

Installation of ArgoCD only needs to be done on a fresh cluster - this does not apply to any current clusters running ArgoCD already.

Requirements

Installed kubectl cli tool
- Have kubeconfig files set up (default location is ~/.kube/config)
- The config is easily populated using a command like below:

`az aks get-credentials --name <cluster name> --resource-group <cluster resource group>`

- Next to install the required services you would use the following commands:

```
kubectl create namespace argocd

kubectl apply -n argocd -f https://raw.githubusercontent.com/argoproj/argo-cd/stable/manifests/install.yaml

```
### Install ArgoCD CLI tool

ou can interact with ArgoCD through the CLI or the gui. To install the cli tool, follow the below instructions:

#### Linux

Set up an environment variable to assign the most recent version number

```bash
VERSION=$(curl --silent "https://api.github.com/repos/argoproj/argo-cd/releases/latest" | grep '"tag_name"' | sed -E 's/.*"([^"]+)".*/\1/')
```

Next use curl to download the most recent Linux version:

```bash
curl -sSL -o /usr/local/bin/argocd https://github.com/argoproj/argo-cd/releases/download/$VERSION/argocd-linux-amd64
```

Lastly make the argocld CLI executable:

```bash
chmod +x /usr/local/bin/argocd
```
#### Mac

Use homebrew to install:

```bash
brew install argocd
```

#### Windows

Download With Powershell: Invoke-WebRequestÂ¶
You can view the latest version of Argo CD at the link above or run the following command to grab the version:

```powershell
$version = (Invoke-RestMethod https://api.github.com/repos/argoproj/argo-cd/releases/latest).tag_name
Replace $version in the command below with the version of Argo CD you would like to download:
```

```powershell
$url = "https://github.com/argoproj/argo-cd/releases/download/" + $version + "/argocd-windows-amd64.exe"
$output = "argocd.exe"

Invoke-WebRequest -Uri $url -OutFile $output
```
Also please note you will probably need to move the file into your PATH.

After finishing the instructions above, you should now be able to run argocd commands


### Accessing the Argo CD API Server

In order to access the Argo CD API Server you use the following command to expose the external IP address. For future iterations of ArgoCD we can look to utilise SSO and SSL as extra layers of security. For now we are using basic http and manually adjusting passwords.

So to access you would need to use following command to change the argo-server service type to "LoadBalancer":

```bash
kubectl patch svc argocd-server -n argocd -p '{"spec": {"type": "LoadBalancer"}}'
```

Now run the following to get the public IP:

```bash
kubectl get svc -n argocd argocd-server

NAME            TYPE           CLUSTER-IP   EXTERNAL-IP    PORT(S)                      AGE
argocd-server   LoadBalancer   x.x.x.xxx   xxx.xx.xxx.xx   80:32117/TCP,443:30284/TCP   4d1h
```

Then if you go to the public IP you will be met by the login screen for ArgoCD

### Login using CLI or GUI

#### CLI Login

The password that is autogenerated to be the pod name of the Argo CD API Server. You can find this out with the following command:

```bash
kubectl get pods -n argocd -l app.kubernetes.io/name=argocd-server -o name | cut -d'/' -f 2
```

Using the username "admin" and the password above, login using the public IP of ArgoCD

```bash
argocd login <public IP>
```

Once logged in you will need to change the password

```bash
argocd account update-password
```

Once you're logged in you have full access to all the Argocd CLI commands and can deploy new charts or sync existing charts.

#### GUI Login

Pretty simple - go to the public IP and use the username "admin" and the password from the below command:

```bash
kubectl get pods -n argocd -l app.kubernetes.io/name=argocd-server -o name | cut -d'/' -f 2
```

### Register a Cluster to Deploy apps to

This is required if you want to deploy to external clusters using ArgoCD. Follow the below to add clusters:

```bash
argocd cluster add
```

Choose a context name from the list and supply it to the following command:

```bash
argocd cluster add <context name>
```

The above command installs a ServiceAccount (argocd-manager), into the kube-system namespace of that kubectl context, and binds the service account to an admin-level ClusterRole. Argo CD uses this service account token to perform its management tasks (i.e. deploy/monitoring).

## 2. Usage

### 2.1 Clone repo 

```
   git clone https://github.com/filetrust/icap-aks-delivery.git
   git submodule init
   git submodule update

```
### 2.2 Add Terraform Backend key to environment

- Get the access to keyvault gw-tfstate-Vault  

- Follow the below commands to get the backend key for Terraform from the Azure Keyvaul 

```
#Check you have access to keyvault using below command
az keyvault secret show --name terraform-backend-key --vault-name gw-tfstate-Vault --query value -o tsv
```

- Next export the environment variable "ARM_ACCESS_KEY" to be able to initialise terraform

```
# export as ARM_ACCESS_KEY
export ARM_ACCESS_KEY=$(az keyvault secret show --name terraform-backend-key --vault-name gw-tfstate-Vault --query value -o tsv)

# now check to see if you can access it through variable
echo $ARM_ACCESS_KEY
```
### 2.3 File modifications

- Currently below needs modifications

    - `main.tf`
      ```key                  = "test1.upwork.terraform.tfstate" ``` 
      
    - `modules/clusters/aks01/variables.tf`
    
    ``` Change "default" field in resource_group , cluster_name ```
    
    - `modules/clusters/argocd-cluster/variables.tf`
    
    ``` Change "default" field in resource_group , cluster_name ```
    
    - `modules/clusters/keyvaults/keyvault-ukw/variables.tf`
    
    ``` Change "default" field in resource_group , kv_name ```
    
    - `modules/clusters/storage-accounts/storage-accounts-ukw/variables.tf`
    
    ``` Change "default" field in resource_group_name ```
    
    - `scripts/az-secret-script/create-az-secret.sh`
    
    `change UKW_VAULT to kv_name default value`
    
    - `scripts\k8s_scripts\create-ns-docker-secret-uks.sh`
    
    ```
    RESOURCE_GROUP= resource group in storage-account
    VAULT_NAME= kv_name default valu
    ```
    
    -  `scripts\argocd-scripts\argocd-app-deloy.sh`
    
    ```
    UKW_RESOURCE_GROUP -  resource_group of aks
    UKW_CONTEXT - cluster_name of aks
    ```
## 3. Deployment
### 3.1 Setup and initialise Terraform
- Next you'll need to use the following:

``` 
terraform init

```
- Next run terraform validate/refresh to check for changes within the state, and also to make sure there aren't any issues.
```
terraform validate
Success! The configuration is valid.

terraform refresh

```

```
terraform plan
```

- Now you're ready to run apply and it should give you the following output
```

terraform apply

Do you want to perform these actions?
  Terraform will perform the actions described above.
  Only 'yes' will be accepted to approve.

  Enter a value:

Enter "yes"

```

### 3.2 Verify context

(make sure to follow above argocd installtion steps)

- Check you are in new created cluster
```
kubectx 

#if new cluster is not highlighted, switch to your cluster using

kubectx <cluster_name>

```

- Check argocd cluster.
```
argocd cluster add 

#If your cluster is not selected from list output, you can switch using

argocd cluster add <cluster name>

```

- Now you have the cluster added you can get the cluster server address using the below command:

```
kubectl cluster-info
Kubernetes master is running at https://gw-icap-k8s-f17703a9.hcp.uksouth.azmk8s.io:443
CoreDNS is running at https://gw-icap-k8s-f17703a9.hcp.uksouth.azmk8s.io:443/api/v1/namespaces/kube-system/services/kube-dns:dns/proxy
Metrics-server is running at https://gw-icap-k8s-f17703a9.hcp.uksouth.azmk8s.io:443/api/v1/namespaces/kube-system/services/https:metrics-server:/proxy

To further debug and diagnose cluster problems, use 'kubectl cluster-info dump'.
```

- if you want to check the status of an ArgoCD app you would use the following:

```
argocd app list 

#it should be empty at this point
```

### 3.3 Copy keyvalt secrets from "gw-tfstate-Vault" to your keyvault

```
chmod +x ./scripts/az-secret-script/create-az-secret.sh 
./scripts/az-secret-script/create-az-secret.sh 
```
### 3.4 Create a self signed certificate.

```
openssl req -newkey rsa:2048 -nodes -keyout tls.key -x509 -days 365 -out certificate.crt

mkdir certs/icap-cert
mkdir certs/mgmt-cert

cp tls.key certs/icap-cert/tls.key
cp tls.key certs/mgmt-cert/tls.key
cp certificate.crt certs/icap-cert/certificate.crt
cp certificate.crt certs/mgmt-cert/certificate.crt

```

### 3.5 Create namespaces in aks resource groups from https://github.com/filetrust/icap-infrastructure
```
chmod +x ./scripts/k8s_scripts/create-ns-docker-secret-uks.sh 
./scripts/k8s_scripts/create-ns-docker-secret-uks.sh 
```

### 3.6 How to deploy using ArgoCD

```
chmod +x ./scripts/argocd-scripts/argocd-app-deloy.sh
./scripts/argocd-scripts/argocd-app-deloy.sh

```

### 4. Sync an ArgoCD app

#### 4.1 Sync From cli
- Get Repo information from 
```
argocd app list

```
- Sync each Repo using command
```
argocd app sync <REPO>
```

#### 4.2 Sync From UI

- Access argocd UI using argocd public <IP>
```
kubectl get svc -n argocd argocd-server

```

- Login to argocd UI

- You can do various function in argocd UI.


# Deviations

2.2.

Firstly make sure you're logged in and using the correct subscription.

```bash

az login

az account list --output table

az account set -s <subscription ID>

```

Next please use the below script to create the following resources:

vim ./scripts/set_env_varibales.sh

Copy Paste below lines and fill proper values.
```
#!/bin/bash

LOCATION=
RESOURCE_GROUP_NAME=
STORAGE_ACCOUNT_NAME=
CONTAINER_NAME=
TAGS='createdby='
VAULT_NAME=

```

```
#!/bin/bash
# Script adapted from https://docs.microsoft.com/en-us/azure/terraform/terraform-backend.
# We cannot create this storage account and blob container using Terraform itself since
# we are creating the remote state storage for Terraform and Terraform needs this storage in terraform init phase.

# Create resource group
az group create --name $RESOURCE_GROUP_NAME --location $LOCATION --tags $TAGS

# Create storage account
az storage account create --resource-group $RESOURCE_GROUP_NAME --name $STORAGE_ACCOUNT_NAME --sku Standard_LRS --encryption-services blob --tags $TAGS

# Get storage account key
ACCOUNT_KEY=$(az storage account keys list --resource-group $RESOURCE_GROUP_NAME --account-name $STORAGE_ACCOUNT_NAME --query [0].value -o tsv)

# Create blob container
az storage container create --name $CONTAINER_NAME --account-name $STORAGE_ACCOUNT_NAME --account-key $ACCOUNT_KEY

az keyvault create --name $VAULT_NAME --resource-group $RESOURCE_GROUP_NAME --location $LOCATION

az keyvault secret set --vault-name $VAULT_NAME --name âterraform-backend-keyâ --value ACCOUNT_KEY

echo "storage_account_name:$RESOURCE_GROUP_NAME"
echo "storage_account_name: $STORAGE_ACCOUNT_NAME"
echo "container_name: $CONTAINER_NAME"
echo "access_key: $ACCOUNT_KEY"
echo "keyVault": $VAULT_NAME

```
## Create terraform service principle

*PLEASE NOTE THIS ONLY NEEDS TO BE DONE ONCE FOR A SINGLE SUBSCRIPTION*

This next part will create a service principle, with the least amount of privileges, to perform the AKS Deployment.

The script below will perform the following:

- Create the service principal (or resets the credentials if it already exists)

- Prompts to choose either a populated or empty provider.tf azurerm provider block

- Exports the environment variables if you selected an empty block (and display the commands)

- Display the az login command to log in as the service principal


```

chmod +x ./scripts/terraform-scripts/create_azure_setup.sh
./scripts/terraform-scripts/create_azure_setup.sh

```

- When prompted `The provider.tf file exists.  Do you want to overwrite? ` , Enter `Y`

- When prompted

```
Will now create a provider.tf file.  Choose output type.
1) Populated azurerm block
2) Empty azurerm block with environment variables
3) Quit
Choose provider block type: 
```

`Choose 2`

- The output will be similar to this:

```
{
"appId": "xyzxyzxyzxyzxyzxyzxyzxyzxyzxyz",
"displayName":"terraform-xyzxyzxyzxyzxyzxyzxyzxyzxyzx",
"name": "http://terraform-xyzxyzxyzxyzxyzxyzxyzxyzxyzxyz",
"password": "xyzxyzxyzxyzxyzxyzxyzxyzxyzxyz",
"tenant": "xyzxyzxyzxyzxyzxyzxyzxyzxyzxyz"
}
Copy the following environment variable exports and paste into your .bashrc file:

export ARM_SUBSCRIPTION_ID="xyzxyzxyzxyzxyzxyzxyzxyzxyzxyz"
export ARM_CLIENT_ID="xyzxyzxyzxyzxyzxyzxyzxyzxyzxyz"
export ARM_CLIENT_SECRET="xyzxyzxyzxyzxyzxyzxyzxyzxyzxyz"
export ARM_TENANT_ID="xyzxyzxyzxyzxyzxyzxyzxyzxyzxyz"

```

Using above output, run below commands

```
az keyvault secret set --vault-name $KEY_VAULT_NAME --name spusername --value <ClientID>

az keyvault secret set --vault-name $KEY_VAULT_NAME --name sppassword --value <Client-Secret>

az keyvault secret set --vault-name $KEY_VAULT_NAME --name "TF-VAR-client-id" --value <ClientID>

az keyvault secret set --vault-name $KEY_VAULT_NAME  --name "TF-VAR-client-secret" --value <Client-Secret>

```
- You need to login to azure account and  search <KEY_VAULT_NAME>,Go to secrets and add below secrets.

```

DH-SA-USERNAME - Dockerhub username ( Get from GW team )
DH-SA-PASSWORD - Dockerhub password ( Get from GW team )
token-username - policy-management
SmtpUser - ( Get from GW team )
SmtpPass - ( Get from GW team )
manage-endpoint -  ( Get from GW team )

```







